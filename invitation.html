<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=640,target-densitydpi=device-dpi,user-scalable=no" />
    <title>邀请函</title>
    <script src="jweixin-1.3.2.js"></script>
    <script src="jquery-1.11.2.min.js"></script>
    <script src="fun.js?9"></script>
    <script>
        window.companyname  = ""
        window.logo  = ""
        window.companyId  = ""

        function login() { 
            var code = getParamer("code"); 
            var url = "https://www.view-ol.com/viewol_web/wx/mpLogin?jscode="+code
            var data = {}
            http_request( url , data , function(re){
                var re = JSON.parse(re)
                if(re.status=="0000"){
                    //登录成功
                    $(".apply").attr("onclick","isPerfectnfo('"+re.result.sessionId+"' , '"+re.result.userId+"',1)");

                    getCompanyInfo(re.result.sessionId , re.result.userId);

                    isPerfectnfo(re.result.sessionId , re.result.userId,0);

                }else{
                    alert(re.message)
                }
            });
        }

        //type == 0 如果没有完善不需要跳转    type==1没有完善需要跳转到完善页面
        function isPerfectnfo(sessionId , userId ,type){
            var url = "https://www.view-ol.com/viewol_web/fuser/isPerfectnfo?userId="+userId
            var data = {}
            var header = {
                "userId": userId,
                "sessionId": sessionId
            }
            http_request2( url , data , header ,  function(re){
                var re = JSON.parse(re)
                if( !userId  || !sessionId){
                    alert("userId、sessionId不存在")
                    return false;
                }
                if(re.status=="0000"){
                    if(type==1){
                        //信息已完善
                        window.location.href="https://www.view-ol.com/mobile/welcome.html?userId="+userId+"&sessionId="+sessionId;
                    }else{
                        $(".apply").html("查看我的邀请函");
                    }

                }else{
                    if(type==1){
                        var companyId = getParamer("companyId");
                        //信息未完善
                        window.location.href="https://www.view-ol.com/mobile/editUserInfo.html?userId="+userId+"&sessionId="+sessionId+"&action=3&companyId=" + companyId;
                    }
                }
            });
        }

        function getCompanyInfo(sessionId , userId ){
            var companyId = getParamer("companyId"); 
                                                // alert("sessionId"+sessionId+"|"+ "userId"+userId+"|"+ "companyId"+companyId)
            var url = "https://www.view-ol.com/viewol_web/company/getCompany?id="+companyId+"&userId="+userId 
            var data = {}
            var header = {
                "userId": userId,
                "sessionId": sessionId
            }
            http_request2( url , data , header ,  function(re){
                var re = JSON.parse(re)
                if(re.code=="0000"){
                    $(".outbox .companyname").html(re.result.name)
                    $(".outbox .wz text").html(re.result.place)
                    $(".outbox .time text").html("2018.10.23 - 2018.10.26")
                    $(".outbox .address text").html("北京市顺义区天竺地区裕翔路88号")
                    // $(".outbox .tel text").html(re.result.place)
                    //设置分享信息
                    setShareMessage(re.result.name,companyId);
                    window.companyname  = re.result.name
                    window.logo  = re.result.logoView
                    window.companyId  = companyId
                }else{
                    alert(re.message)
                }
            });
        }

        



        var xhr = new XMLHttpRequest();
        xhr.open('get', 'https://www.view-ol.com/viewol_web/wx/jsapiSignature?url=' + encodeURIComponent(window.location.href.replace(window.location.hash, '')), true);
        xhr.onreadystatechange = function () {
            // alert(xhr.status);
            if (xhr.readyState == 4 && xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                
                if (data && data.status == '0000') {
                    wx.config({
                        appId: data.result.appId,
                        timestamp: data.result.timestamp,
                        nonceStr: data.result.nonceStr,
                        signature: data.result.signature,
                        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage','chooseWXPay'],
                        debug:false
                    });
                }
            }
        };
        xhr.send();

        wx.ready(function(){
            login();
        });

        function setShareMessage(companyname,companyId){
            wx.onMenuShareTimeline({
                title: companyname + "邀请您参加安博会", // 分享标题
                link: 'https://www.view-ol.com/mobile/invitation_index.html?companyId='+companyId, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: "https://www.view-ol.com/mobile/images/logo_share.png", // 分享图标
                success: function () {


                }
            });

            // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
            wx.onMenuShareAppMessage({
                title: "中国国际社会公共安全产品博览会", // 分享标题
                desc: companyname + "邀请您参加安博会", // 分享描述
                link: 'https://www.view-ol.com/mobile/invitation_index.html?companyId='+companyId, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl:"https://www.view-ol.com/mobile/images/logo_share.png",// 分享图标
                success: function () {

                },
                cancel: function () {

                }

            });
        }

        wx.error(function(res){
            // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
            alert("err");
        });

    </script>
</head>

<body>
<script>

</script>

<style type="text/css">
    body{background:#0b1457;}
    html,body,ul,li,p{padding:0;margin:0;}
    .outbox{background:url(images/cz.jpg) no-repeat center top;background-size:100% auto;width:640px;height: 100%;position: relative;min-height: 1160px;}
    .outbox .apply{width:400px;height:70px;font-size: 26px;color: #3d3ab2;font-weight: bold;border-radius:80px;background:#fff;top:900px;text-align: center;line-height:70px;left:50%;margin-left:-204px;position:absolute;border:4px #11357c solid;}

    .companyname{color:#fff;font-size:24px;font-weight:bold;text-align: center;position: absolute;display: block; width: 100%;top: 511px;}
    .tips{color: #8ab8ed; font-size: 20px; text-align: center; width: 460px; position: absolute; display: block; top: 541px; left: 50%; margin-left: -230px;}

    .outbox .wz{padding-top: 640px;}
    .outbox .wz , .outbox .time , .outbox .address , .outbox .tel{color:#8ab8ed;font-size:22px;display:block;width:100%;text-align: center;}
</style>

<div class="outbox">
    <div class="companyname"> </div>
    <div class="tips">诚邀您在第十四届中国国际社会公共安全产品博览会期间莅临我们的展位</div>

    <div class="wz">展位号：<text></text></div>
    <div class="time">展出时间：<text></text></div>
    <div class="address">地址：<text></text></div>
    <!-- <div class="tel">电话：<text></text></div> -->

    <div class="apply">我要参加</div>
</div>

</body>
</html>